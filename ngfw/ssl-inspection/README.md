# SSL Inspection

For encrypted traffic that goes through the firewall, FortiGate uses the SNI (Server Name Indication) field in the client hello message to understand the web server's name. The name is validated against a DNS name before receipt of the server certificate.&#x20;

If there is no SNI sent, then fortigate identifies the server by the value in the Subject field of SAN field of the server's certificate.

## Certificate Inspection

Certificate inspection is used to only verify the identity of web servers but the data exhanged between client and server is not inspected. With Certificate Inspection, only web filtering and application control can be enabled

## Full Inspection

Full inspection requires that FortiGate acts as a CA to generate SSL private keys and certificates. This means that the SSL channel is established between client and FortiGate and then a new channel is established between FortiGate and server.

FortiGate can use it's own self-signed Fortinet\_CA\_SSL certificate to sign the certificates it genertates, or it can use a certificate issued by an internal CA. In this case,  FortiGate acts as a subordinate CA

In both cases, the root CA certificate must be imported into the clients machines in order to avoid security warnings.

Also, on the FortiGate, the chain of certificates must be installed so they can be sent to the client.

### Outbound Traffic

To enable Full SSL Inspection for outbound traffic (from internal clients to external servers), the the option "**Multiple Clients connecting to Multiple Servers**" needs to be enabled on the SSL/SSH profile.  Then, you must select the CA certificate that will be used to sign server certificates.&#x20;

#### Untrusted SSL Certificates

Another option is to decide what to do in case untrusted certificates are received from the outside web servers. The options are:

* **Allow**: FortiGate sends to the internal client a temporary certificate signed by Fortinet\_CA\_Untrusted certificate. This certificate should not be imported to the client machines in order to generate a warning. Only if the client accepts the security risk, the session is established and then the FortiGate establishes a session with the server. Even if the client decides to add the server certificate to it's certificate store, next time it tries to connect a new temporary certificate will be generated by FortiGate so the security warning will still be visible.
* **Block**: Connection to outside server is blocked and the client is served a web page from the FortiGate notifiying them that the site is blocked.
* **Ignore**: FortiGate sends to the internal client a temporary certificate signed by the selected CA certificate and estabishes the SSL session

For trusted certificates, the temporary certificate sent to the client will be signed by the selected CA certificate in the profile.

#### Invalid SSL Certificates

Some websites present invalid certificates. This could be because:

* Certificate expired
* Certificate was revoked (based on CRL or OCSP information)
* Validation timeout - Certificate could not be validated due to a communication timeout
* Validation failed - Certificate could not be validated due to a communication error

For invalid SSL Certificates, you have these options:

* Trust & Allow: FortiGate allows the website and considers the certificate as "trusted". Temporary certificate is signed by the selected CA of the profile
* Block: FortiGate blocks the content of the website
* Keep Untrusted & Allow: Fortigate allows the website but considers the certificate as "untrusted" and lets the client browser decide. Temporary certificate is signed by the Fortinet\_CA\_Untrusted certificate.

#### Exemptions from SSL Inspection

Some websites may not work when when SSL Inspection is in use. For example, when websites use [HPKP](https://en.wikipedia.org/wiki/HTTP\_Public\_Key\_Pinning). Other times, laws in some jurisdictions make it illegal to inspect SSL traffic for specific websites.&#x20;

This feature allows defining a list of web sites that will be exempt from SSL inspection.  You can exempt sites based on their address or on their web category. There is also an option to disable SSL inspection for "Reputable websites" - which is a list maintained and updated regularly by FortiGuard.

## &#x20;Inbound Traffic

For inboud traffic, the SSL inspection has to be set to "Protecing SSL Server". In this case, the server certificate chain must be added to the FortiGate in order to be presented to the external clients. This way, the traffic to the server can be inspected by the FortiGate.&#x20;

The profile can be used to protect multiple servers so you have the possiblity to add multiple certificates in this profile. FortiGate uses the SNI value in the hello against the CN (Common Name) on the certificate to select which certificate to present to the client.&#x20;

If the SNI does not match any CN in the list, the FortiGate will select the first certificate in the list and present it to the client

## SSL Inspection Profiles

For each firewall policy rule, an SSL Inspection Profile can be selected. There is a built-in "no-inspection" profile that can be used if you don't want to perform SSL inspection.

When full SSL inspection is enabled, there is an additional option to send a copy of the decrypted SSL traffic to an interface for additional inspection.

